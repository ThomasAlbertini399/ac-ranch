<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AC Ranch - Gestione Cavalli</title>

  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- FullCalendar CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css"
    rel="stylesheet"
  />

  <style>
    body { 
      padding-top: 1rem; 
      background: #f8f9fa; 
      font-size: 15px;
      font-family: system-ui, -apple-system, sans-serif;
    }
    
    h1 { 
      margin-bottom: 1rem; 
      text-align: center; 
      font-size: 1.7rem;
      font-weight: 600;
    }
    
    .card { 
      margin-bottom: 1rem; 
      border-radius: 8px;
    }
    
    /* Miglioramenti al calendario per smartphone */
    .fc { 
      font-size: 0.9rem; 
      height: auto;
      touch-action: pan-y; /* Permettere lo scroll verticale */
    }
    
    .fc .fc-toolbar-title {
      font-size: 1.4rem;
      font-weight: 600;
    }
    
    .fc .fc-button {
      padding: 0.3rem 0.6rem;
      font-size: 0.85rem;
    }
    
    .fc .fc-timegrid-slot-lane { 
      border-top: 1px solid #dee2e6; 
    }
    
    .fc .fc-timegrid-slot-minor { 
      border-top: 1px dashed #e9ecef; 
    }
    
    .fc .fc-timegrid-slots td {
      height: 2.5em;
    }
    
    .fc .fc-event { 
      font-size: 0.8rem; 
      padding: 2px 4px; 
      border-radius: 4px;
      margin: 1px 0;
    }
    
    /* Aggiunto: Stile specifico per la vista mensile */
    .fc .fc-daygrid-day-frame {
      min-height: 60px; /* Altezza minima per le celle giornaliere */
      display: flex;
      flex-direction: column;
    }
    
    .fc .fc-daygrid-day-events {
      min-height: 40px; /* Spazio per gli eventi */
    }
    
    .fc .fc-daygrid-day-bottom {
      padding: 2px;
    }
    
    .fc .fc-daygrid-more-link {
      font-size: 0.75rem;
    }
    
    .weekly-dates { 
      font-size: 0.9rem; 
      color: #666; 
    }
    
    /* Aggiornato: Stile per i pulsanti cavallo */
    .horse-btn { 
      margin-bottom: 0.5rem; 
      position: relative;
    }
    
    .horse-btn.available {
      border-color: #198754;
      color: #198754;
    }
    
    .horse-btn.unavailable {
      border-color: #dc3545;
      color: #dc3545;
      background-color: rgba(220, 53, 69, 0.05);
    }
    
    .note-text { 
      color: #555; 
      font-style: italic; 
    }
    
    .note-card { 
      font-size: 0.9rem; 
      margin-bottom: 0.5rem; 
      border-left: 3px solid #0d6efd; 
      padding: 0.5rem; 
      background-color: #f8f9fa; 
      border-radius: 4px;
    }
    
    .note-card .horse-name { 
      font-weight: bold; 
      color: #0d6efd; 
    }
    
    .note-actions { 
      display: flex; 
      gap: 0.5rem; 
      margin-top: 0.5rem; 
      flex-wrap: wrap;
    }
    
    /* Colori per le ore di lavoro */
    .badge.hours-low {
      background-color: #198754 !important; /* Verde */
    }
    
    .badge.hours-medium {
      background-color: #fd7e14 !important; /* Arancione */
    }
    
    .badge.hours-high {
      background-color: #dc3545 !important; /* Rosso */
    }

    /* Sempre blu per i totali */
    .badge.total-hours {
      background-color: #0d6efd !important; /* Blu */
    }
    
    /* Rendi pi√π grande l'area toccabile per i pulsanti del calendario */
    .fc-button {
      min-height: 38px;
      min-width: 38px;
    }
    
    /* Pulsante nuovo evento */
    .new-event-btn {
      margin-bottom: 1rem;
      width: 100%;
    }
    
    /* Aggiunto: Indicatore di disponibilit√† */
    .availability-indicator {
      font-size: 0.75rem;
      position: absolute;
      top: -8px;
      right: -8px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    
    .availability-indicator.available {
      background-color: #198754;
    }
    
    .availability-indicator.unavailable {
      background-color: #dc3545;
    }
    
    /* Login panel */
    #login-container {
      max-width: 400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
    }
    
    .loading-spinner {
      width: 3rem;
      height: 3rem;
    }
    
    .user-info {
      font-size: 0.9rem;
      margin-left: auto;
    }
    
    /* NUOVO: Stile per il divisore di giorni negli eventi settimanali */
    .day-divider {
      background-color: #e9ecef;
      padding: 5px 10px;
      font-weight: 600;
      margin-top: 10px;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    /* NUOVO: Stile per le informazioni di ferratura */
    .shoeing-info {
      margin: 15px 0;
      padding: 10px;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      background-color: #f8f9fa;
    }
    
    /* NUOVO: Modifica note multiple */
    .notes-list {
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 10px;
    }
    
    .note-item {
      padding: 8px;
      margin-bottom: 5px;
      border-left: 3px solid #0d6efd;
      background-color: #f8f9fa;
      border-radius: 4px;
      position: relative;
    }
    
    .note-date {
      font-size: 0.75rem;
      color: #6c757d;
      margin-bottom: 3px;
    }
    
    .delete-note-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 0.75rem;
      padding: 2px 5px;
    }
    
    @media (max-width: 576px) {
      .fc .fc-col-header-cell-cushion { 
        font-size: 0.85rem;
        font-weight: 600;
        padding: 6px 2px;
      }
      
      .fc .fc-timegrid-slot-label { 
        font-size: 0.8rem;
        font-weight: 500;
      }
      
      .modal-footer .btn { 
        padding: 0.375rem 0.5rem; 
      }
      
      /* Migliorare la visualizzazione della toolbar del calendario */
      .fc-toolbar.fc-header-toolbar {
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .fc-toolbar-chunk {
        display: flex;
        justify-content: center;
      }
      
      /* Lascia scorrere meglio su dispositivi touch */
      .fc-scroller {
        -webkit-overflow-scrolling: touch;
      }
    }
  </style>
</head>
<body>
  <!-- Overlay di caricamento -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="spinner-border loading-spinner text-primary" role="status"></div>
    <p class="mt-3">Caricamento in corso...</p>
  </div>

  <!-- Contenitore login (mostra all'avvio) -->
  <div id="login-container" class="card shadow p-4">
    <h2 class="text-center mb-4">üê¥ AC Ranch</h2>
    <p class="text-center mb-4">Accedi per gestire i cavalli</p>
    
    <div class="mb-3">
      <label for="email" class="form-label">Email</label>
      <input type="email" class="form-control" id="email" required>
    </div>
    <div class="mb-3">
      <label for="password" class="form-label">Password</label>
      <input type="password" class="form-control" id="password" required>
    </div>
    <div class="d-grid gap-2">
      <button id="login-btn" class="btn btn-primary">Accedi</button>
      <p id="login-error" class="text-danger mt-2 text-center"></p>
    </div>
  </div>

  <!-- Contenitore principale app (nascosto all'avvio) -->
  <div id="app-container" class="container d-none">
    <div class="d-flex align-items-center justify-content-center mb-3">
      <h1 class="mb-0">üê¥ AC Ranch - Gestione Cavalli</h1>
      <div class="user-info ms-2">
        <span id="user-email" class="badge bg-secondary"></span>
        <button id="logout-btn" class="btn btn-sm btn-outline-secondary ms-2">Esci</button>
      </div>
    </div>
    
    <!-- Pulsante Nuovo Evento -->
    <button id="new-event-button" class="btn btn-primary new-event-btn">
      <i class="bi bi-plus-circle"></i> Crea Nuovo Evento
    </button>
    
    <div id="calendar" class="card shadow-sm p-0 mb-4"></div>

    <div class="row">
      <!-- Riepiloghi -->
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5>Riepilogo per data</h5>
            <input type="date" id="summary-date" class="form-control mb-3"/>
            <h6>Ore giornaliere</h6>
            <div id="hours" class="list-group mb-3"></div>
            <h6>Eventi giornalieri</h6>
            <ul id="daily-events" class="list-group mb-3"></ul>
            <h6>Ore settimanali <span id="week-range" class="weekly-dates"></span></h6>
            <div id="weekly-hours" class="list-group mb-3"></div>
            <h6>Eventi settimanali</h6>
            <ul id="weekly-events" class="list-group"></ul>
          </div>
        </div>
      </div>
      <!-- Profili e note cavalli -->
      <div class="col-md-6">
        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <h5>Profili Cavalli</h5>
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="input-group">
                <input type="text" id="new-horse-name" class="form-control" placeholder="Nome nuovo cavallo">
                <button class="btn btn-primary" id="add-horse-btn" type="button">Aggiungi</button>
              </div>
            </div>
            <div id="profiles-list" class="d-flex flex-wrap gap-2"></div>
          </div>
        </div>
        <!-- Bacheca Note -->
        <div class="card shadow-sm">
          <div class="card-body">
            <h5>Bacheca Note Cavalli</h5>
            <div class="alert alert-info mb-3" role="alert" id="notes-help">
              Qui vengono visualizzate tutte le note dei cavalli per una rapida consultazione.
              Le note possono essere gestite e rimosse dalla bacheca.
            </div>
            <div id="notes-dashboard"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Evento -->
  <div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modal-title">Nuova Attivit√†</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="event-form">
          <div class="mb-3">
            <label class="form-label">Cavalli (opzionale)</label>
            <select id="horses-select" class="form-select" multiple></select>
            <div id="unavailable-horses-warning" class="alert alert-warning mt-2 d-none">
              Attenzione: alcuni cavalli selezionati sono indisponibili!
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Tipo Attivit√†</label>
            <select id="activity-type" class="form-select" required>
              <option value="">-- seleziona tipo --</option>
              <option value="passeggiata">Passeggiata</option>
              <option value="lezione">Lezione</option>
              <option value="ferratura">Ferratura</option>
              <option value="altro">Altro</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Inizio</label>
            <input type="datetime-local" id="start-time" class="form-control" required/>
          </div>
          <div class="mb-3">
            <label class="form-label">Fine</label>
            <input type="datetime-local" id="end-time" class="form-control" required/>
          </div>
          <div class="mb-3">
            <label class="form-label">Note</label>
            <textarea id="event-notes" class="form-control" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button id="delete-event" class="btn btn-danger me-auto" type="button">Elimina</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Annulla</button>
        <button id="save-event" class="btn btn-primary" type="button">Salva</button>
      </div>
    </div></div>
  </div>

  <!-- Modal Profilo Cavallo -->
  <div class="modal fade" id="profileModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="profile-title">Profilo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- NUOVO: Sezione per aggiungere note multiple -->
        <div class="mb-3">
          <label class="form-label">Aggiungi nota sul cavallo</label>
          <textarea id="horse-notes" class="form-control mb-2" rows="3"></textarea>
          <button id="save-horse-notes" class="btn btn-sm btn-primary" type="button">Aggiungi nota</button>
        </div>
        
        <!-- NUOVO: Lista delle note del cavallo -->
        <div class="mb-3">
          <h6>Note del cavallo:</h6>
          <div id="horse-notes-list" class="notes-list"></div>
        </div>
        
        <div class="mb-3">
          <div id="availability-container" class="d-grid gap-2">
            <button id="toggle-availability" class="btn btn-danger" type="button">
              Rendi indisponibile
            </button>
          </div>
        </div>
        
        <!-- NUOVO: Informazioni ferratura -->
        <div class="mb-3 shoeing-info">
          <h6>Ultima ferratura:</h6>
          <div class="d-flex align-items-center">
            <span class="me-2">Data:</span>
            <input type="date" id="shoeing-date" class="form-control">
            <button id="save-shoeing-date" class="btn btn-sm btn-primary ms-2">Salva</button>
          </div>
        </div>
        
        <h6>Eventi del cavallo:</h6>
        <ul id="profile-events" class="list-group"></ul>
      </div>
      <div class="modal-footer">
        <button id="delete-horse-btn" class="btn btn-danger me-auto" type="button">Elimina cavallo</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Chiudi</button>
      </div>
    </div></div>
  </div>

  <!-- Modal Eliminazione Cavallo -->
  <div class="modal fade" id="deleteHorseModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Conferma eliminazione</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Eliminare il cavallo <strong id="delete-horse-name"></strong>?</p>
        <p class="text-danger">Non annullabile e rimuove da tutti gli eventi.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Annulla</button>
        <button id="confirm-delete-horse" class="btn btn-danger" type="button">Elimina</button>
      </div>
    </div></div>
  </div>

  <!-- JS Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

  <script>
  // IMPORTANTE: Sostituisci con le tue informazioni Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBKCIQXvqVrLQdVaXIZpEAAQMUmcRc-wJE",
    authDomain: "ac-ranch-gestione-cavalli.firebaseapp.com",
    databaseURL: "https://ac-ranch-gestione-cavalli-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "ac-ranch-gestione-cavalli",
    storageBucket: "ac-ranch-gestione-cavalli.firebasestorage.app",
    messagingSenderId: "348337156367",
    appId: "1:348337156367:web:0b27229e0a7264465e4e7a"
  };
  
  // Inizializza Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const database = firebase.database();
  
  document.addEventListener('DOMContentLoaded', () => {
    // Elementi UI per il login
    const loginContainer = document.getElementById('login-container');
    const appContainer = document.getElementById('app-container');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginError = document.getElementById('login-error');
    const userEmailElement = document.getElementById('user-email');
    
    // Abilita/disabilita loading overlay
    function setLoading(isLoading) {
      if (isLoading) {
        loadingOverlay.classList.remove('d-none');
      } else {
        loadingOverlay.classList.add('d-none');
      }
    }
    
    // Login con email e password
    loginBtn.addEventListener('click', () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      
      if (!email || !password) {
        loginError.textContent = 'Inserisci email e password';
        return;
      }
      
      setLoading(true);
      loginError.textContent = '';
      
      auth.signInWithEmailAndPassword(email, password)
        .catch(error => {
          console.error('Errore login:', error);
          
          // Messaggio di errore in italiano
          let errorMessage = 'Errore durante l\'accesso. Riprova.';
          if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
            errorMessage = 'Email o password non corretti';
          } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'Email non valida';
          } else if (error.code === 'auth/too-many-requests') {
            errorMessage = 'Troppi tentativi falliti. Riprova pi√π tardi.';
          }
          
          loginError.textContent = errorMessage;
          setLoading(false);
        });
    });
    
    // Logout
    logoutBtn.addEventListener('click', () => {
      auth.signOut();
    });
    
    // Gestisci stato autenticazione
    auth.onAuthStateChanged(user => {
      setLoading(false);
      
      if (user) {
        // Utente loggato
        loginContainer.classList.add('d-none');
        appContainer.classList.remove('d-none');
        userEmailElement.textContent = user.email;
        
        // Ora inizializziamo l'app con Firebase
        initializeApp(user);
      } else {
        // Utente non loggato
        loginContainer.classList.remove('d-none');
        appContainer.classList.add('d-none');
        emailInput.value = '';
        passwordInput.value = '';
      }
    });
    
    // Pressione tasto Invio nel form di login
    passwordInput.addEventListener('keyup', (event) => {
      if (event.key === 'Enter') {
        loginBtn.click();
      }
    });
    
    function initializeApp(user) {
      // Riferimenti al database
      const dbRef = database.ref('ranch_data');
      
      // Dati iniziali
      let cavalli = [];
      let cavalliNotes = {};         // MODIFICATO: Ora conterr√† array di note con data
      let noteDaGestire = {};        // Invariato: Indica quali note sono da gestire
      let cavalliDisponibilita = {}; // Invariato: Stato disponibilit√†
      let cavalliFerratura = {};     // NUOVO: Date di ferratura per cavallo
      
      const activities     = ["passeggiata","lezione","ferratura","altro"];
      const workActivities = ["passeggiata","lezione"];
      const activityColors = {
        "passeggiata":"#198754","lezione":"#0d6efd",
        "ferratura":"#dc3545","altro":"#6c757d"
      };
      const todayFormatted = new Date().toISOString().slice(0,10);

      // Riferimenti UI
      const calendarEl         = document.getElementById('calendar');
      const dateInput          = document.getElementById('summary-date');
      const hoursEl            = document.getElementById('hours');
      const dailyListEl        = document.getElementById('daily-events');
      const weeklyHoursEl      = document.getElementById('weekly-hours');
      const weeklyListEl       = document.getElementById('weekly-events');
      const weekRangeEl        = document.getElementById('week-range');
      const profilesList       = document.getElementById('profiles-list');
      const notesDashboard     = document.getElementById('notes-dashboard');
      const newHorseInput      = document.getElementById('new-horse-name');
      const addHorseBtn        = document.getElementById('add-horse-btn');
      const newEventBtn        = document.getElementById('new-event-button');
      const horseNotesEl       = document.getElementById('horse-notes');        // Modificato: ora per aggiungere una singola nota
      const horseNotesListEl   = document.getElementById('horse-notes-list');   // NUOVO: Lista delle note del cavallo
      const saveHorseNotesBtn  = document.getElementById('save-horse-notes');   // Modificato: ora per aggiungere una nota
      const shoeingDateEl      = document.getElementById('shoeing-date');       // NUOVO: Data ferratura
      const saveShoeingDateBtn = document.getElementById('save-shoeing-date');  // NUOVO: Pulsante salva data ferratura
      const confirmDeleteHorseBtn = document.getElementById('confirm-delete-horse');
      const deleteHorseBtn     = document.getElementById('delete-horse-btn');
      const unavailableHorsesWarning = document.getElementById('unavailable-horses-warning');
      const toggleAvailabilityBtn = document.getElementById('toggle-availability');
      const eventModal    = new bootstrap.Modal(document.getElementById('eventModal'));
      const profileModal  = new bootstrap.Modal(document.getElementById('profileModal'));
      const deleteHorseModal = new bootstrap.Modal(document.getElementById('deleteHorseModal'));
      const form          = document.getElementById('event-form');
      const selectEl      = document.getElementById('horses-select');
      const typeEl        = document.getElementById('activity-type');
      const startEl       = document.getElementById('start-time');
      const endEl         = document.getElementById('end-time');
      const notesEl       = document.getElementById('event-notes');
      const deleteBtn     = document.getElementById('delete-event');
      const saveBtn       = document.getElementById('save-event');
      const modalTitle    = document.getElementById('modal-title');
      const profileTitle  = document.getElementById('profile-title');
      const profileEvents = document.getElementById('profile-events');

      let editingEvent = null, currentHorse = null;
      let touchStartTime = 0;
      let touchStartY = 0;
      let moved = false;

      // FullCalendar init
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        firstDay: 1,
        slotMinTime: "00:00",
        slotMaxTime: "24:00",
        slotDuration: '01:00:00',
        defaultTimedEventDuration: '01:00:00',
        selectable: true,
        selectMinDistance: 5, // Ridotta per facilitare il tap
        selectLongPressDelay: 150, // Ridotto per rendere pi√π reattivo il tap
        editable: true,
        nowIndicator: true,
        locale: 'it',
        timeZone: 'local',
        height: 'auto', // Altezza automatica per adattarsi meglio ai dispositivi
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        buttonText: {
          today: 'Oggi',
          month: 'Mese',
          week: 'Sett.',
          day: 'Giorno'
        },
        allDaySlot: false, // Rimuove la riga all-day
        // Modificato: Configurazioni specifiche per la vista mensile
        views: {
          dayGridMonth: {
            // Aumenta l'altezza della vista mensile e imposta la visualizzazione degli eventi
            dayMaxEventRows: 3, // Massimo 3 eventi visibili per cella
          }
        },
        select: info => {
          calendar.unselect();
          // Otteniamo l'ora esatta cliccata e correggiamo eventuali problemi di fuso orario
          const s = new Date(info.startStr);
          // Calcoliamo la fine esattamente un'ora dopo
          const e = new Date(s.getTime() + 3600000);
          openForm(null, s, e);
        },
        eventClick: info => openForm(info.event, info.event.start, info.event.end),
        eventDrop: ()=>{ saveEvents(); updateAll(); },
        eventResize: ()=>{ saveEvents(); updateAll(); },
        eventDidMount: info => {
          if (info.event.extendedProps.notes) {
            new bootstrap.Tooltip(info.el, {
              title: info.event.extendedProps.notes,
              placement: 'top',
              trigger: 'hover',
              container: 'body'
            });
          }
        }
      });
      calendar.render();

      // Migliorare l'interazione touch sul calendario
      calendarEl.addEventListener('touchstart', function(e) {
        touchStartTime = Date.now();
        touchStartY = e.touches[0].clientY;
        moved = false;
      }, { passive: true });

      calendarEl.addEventListener('touchmove', function(e) {
        const yDiff = Math.abs(e.touches[0].clientY - touchStartY);
        if (yDiff > 5) { // Ridotta la soglia per migliorare la reattivit√†
          moved = true;
        }
      }, { passive: true });

      calendarEl.addEventListener('touchend', function(e) {
        // Se il tocco √® durato meno di 300ms e non ci sono stati movimenti significativi,
        // consideriamolo come un tap per selezionare una cella
        const touchDuration = Date.now() - touchStartTime;
        if (touchDuration < 300 && !moved) {
          // Non facciamo nulla qui, lasciamo che FullCalendar gestisca il tap
        }
      }, { passive: true });

      // Pulsante nuovo evento
      newEventBtn.addEventListener('click', function() {
        const now = new Date();
        // Arrotondiamo all'ora successiva
        const nextHour = new Date(now);
        nextHour.setHours(now.getHours() + 1);
        nextHour.setMinutes(0);
        nextHour.setSeconds(0);
        nextHour.setMilliseconds(0);
        
        // Calcoliamo l'ora di fine (un'ora dopo l'inizio)
        const endHour = new Date(nextHour.getTime() + 3600000);
        
        openForm(null, nextHour, endHour);
      });

      // NUOVO: Salva data ferratura
      saveShoeingDateBtn.addEventListener('click', function() {
        const date = shoeingDateEl.value;
        if (currentHorse) {
          cavalliFerratura[currentHorse] = date;
          saveHorseFerratura();
          alert('Data ferratura salvata!');
        }
      });

      // Firebase helpers
      function saveHorses() {
        dbRef.child('cavalli').set(cavalli);
        renderHorsesUI();
      }
      
      // MODIFICATO: Salva note cavalli (ora √® un array di note con data)
      function saveHorseNotes() {
        dbRef.child('cavalliNotes').set(cavalliNotes);
      }
      
      function saveNotesToManage() {
        dbRef.child('noteDaGestire').set(noteDaGestire);
      }
      
      function saveHorseAvailability() {
        dbRef.child('cavalliDisponibilita').set(cavalliDisponibilita);
      }
      
      // NUOVO: Salva date ferratura
      function saveHorseFerratura() {
        dbRef.child('cavalliFerratura').set(cavalliFerratura);
      }
      
      function saveEvents() {
        const arr = calendar.getEvents().map(e=>({
          id: e.id,
          title: e.title,
          start: e.start.toISOString(),
          end:   e.end.toISOString(),
          extendedProps: e.extendedProps,
          backgroundColor: e.backgroundColor
        }));
        dbRef.child('events').set(arr);
      }
      
      // Carica dati da Firebase
      function loadData() {
        setLoading(true);
        
        dbRef.once('value')
          .then(snapshot => {
            const data = snapshot.val() || {};
            
            // Carica tutti i dati o imposta i valori predefiniti
            cavalli = data.cavalli || ["Angel","Celine","Dior","John","Nina","Pioggia","Revoltoso","Wapi","Zia"];
            
            // MODIFICATO: Converti il vecchio formato delle note (stringa) al nuovo formato (array di oggetti)
            cavalliNotes = data.cavalliNotes || {};
            // Conversione vecchio formato -> nuovo formato
            for (const horseName in cavalliNotes) {
              if (typeof cavalliNotes[horseName] === 'string') {
                // Se √® una stringa, convertiamo in array con un singolo oggetto
                if (cavalliNotes[horseName].trim()) {
                  cavalliNotes[horseName] = [{
                    text: cavalliNotes[horseName],
                    date: new Date().toISOString(),
                    id: Date.now().toString()
                  }];
                } else {
                  // Se √® vuoto, inizializziamo come array vuoto
                  cavalliNotes[horseName] = [];
                }
              } else if (!Array.isArray(cavalliNotes[horseName])) {
                // Se non √® un array e non √® una stringa, inizializziamo come array vuoto
                cavalliNotes[horseName] = [];
              }
            }
            
            // Inizializza array vuoti per i cavalli che non hanno note
            cavalli.forEach(h => {
              if (!cavalliNotes[h]) {
                cavalliNotes[h] = [];
              }
            });
            
            noteDaGestire = data.noteDaGestire || {};
            cavalliDisponibilita = data.cavalliDisponibilita || {};
            cavalliFerratura = data.cavalliFerratura || {}; // NUOVO: Carica date ferratura
            
            // Inizializza disponibilit√† per i cavalli che non ne hanno
            cavalli.forEach(h => {
              if (cavalliDisponibilita[h] === undefined) {
                cavalliDisponibilita[h] = true; // true = disponibile
              }
            });
            
            // Carica gli eventi nel calendario
            calendar.removeAllEvents();
            if (data.events && Array.isArray(data.events)) {
              data.events.forEach(ev => calendar.addEvent(ev));
            }
            
            // Aggiorna l'interfaccia
            renderHorsesUI();
            updateAll();
            setLoading(false);
          })
          .catch(error => {
            console.error('Errore caricamento dati:', error);
            setLoading(false);
            alert('Errore durante il caricamento dei dati. Riprova pi√π tardi.');
          });
      }
      
      // Quando i dati cambiano in Firebase, aggiorna l'app
      dbRef.on('value', snapshot => {
        const data = snapshot.val() || {};
        
        // Aggiorniamo solo se ci sono cambiamenti effettivi
        // Nota: confrontiamo le stringhe JSON per evitare problemi con riferimenti di oggetti
        const newCavalli = JSON.stringify(data.cavalli || []);
        const newNotes = JSON.stringify(data.cavalliNotes || {});
        const newNoteDaGestire = JSON.stringify(data.noteDaGestire || {});
        const newDisponibilita = JSON.stringify(data.cavalliDisponibilita || {});
        const newFerratura = JSON.stringify(data.cavalliFerratura || {}); // NUOVO: Confronta date ferratura
        const currentCavalli = JSON.stringify(cavalli);
        const currentNotes = JSON.stringify(cavalliNotes);
        const currentNoteDaGestire = JSON.stringify(noteDaGestire);
        const currentDisponibilita = JSON.stringify(cavalliDisponibilita);
        const currentFerratura = JSON.stringify(cavalliFerratura); // NUOVO: Confronta date ferratura
        
        // Verifica se gli eventi sono cambiati
        let eventsChanged = false;
        if (data.events) {
          const currentEvents = calendar.getEvents().map(e => e.id).sort().join(',');
          const newEvents = data.events.map(e => e.id).sort().join(',');
          eventsChanged = currentEvents !== newEvents;
        }
        
        // Se qualcosa √® cambiato, ricarichiamo i dati
        if (newCavalli !== currentCavalli ||
            newNotes !== currentNotes ||
            newNoteDaGestire !== currentNoteDaGestire ||
            newDisponibilita !== currentDisponibilita ||
            newFerratura !== currentFerratura || // NUOVO: Confronta date ferratura
            eventsChanged) {
          
          // Ricarica solo se non stiamo gi√† caricando
          if (!loadingOverlay.classList.contains('d-none')) return;
          
          console.log('Dati cambiati in Firebase, ricarico...');
          loadData();
        }
      });

      // Verifica cavalli indisponibili selezionati
      function checkSelectedUnavailableHorses() {
        const selectedHorses = Array.from(selectEl.selectedOptions).map(o => o.value);
        const unavailableSelected = selectedHorses.some(h => !cavalliDisponibilita[h]);
        const activityType = typeEl.value;
        
        // Mostra avviso se ci sono cavalli indisponibili selezionati
        if (unavailableSelected && (activityType === 'passeggiata' || activityType === 'lezione')) {
          unavailableHorsesWarning.classList.remove('d-none');
          saveBtn.disabled = true;
        } else {
          unavailableHorsesWarning.classList.add('d-none');
          saveBtn.disabled = false;
        }
      }

      // Event listener per il cambio di selezione cavalli
      selectEl.addEventListener('change', checkSelectedUnavailableHorses);
      
      // Event listener per il cambio di tipo attivit√†
      typeEl.addEventListener('change', checkSelectedUnavailableHorses);

      // Render cavalli UI
      function renderHorsesUI() {
        // Aggiorna il dropdown dei cavalli nel form eventi
        selectEl.innerHTML = '';
        cavalli.forEach(h => {
          const o = document.createElement('option');
          o.value = h;
          o.textContent = h;
          
          // Aggiungi indicatore di disponibilit√† al nome
          if (!cavalliDisponibilita[h]) {
            o.textContent = `${h} (Non disponibile)`;
            o.classList.add('text-danger');
          }
          
          selectEl.append(o);
        });
        
        // Aggiorna la lista dei profili cavalli
        profilesList.innerHTML = '';
        cavalli.forEach(h => {
          const btn = document.createElement('button');
          // Imposta classe in base alla disponibilit√†
          const disponibile = cavalliDisponibilita[h];
          btn.className = `btn horse-btn ${disponibile ? 'available' : 'unavailable'}`;
          btn.textContent = h;
          btn.onclick = () => openProfile(h);
          
          // Aggiungi indicatore di disponibilit√†
          const indicator = document.createElement('span');
          indicator.className = `availability-indicator ${disponibile ? 'available' : 'unavailable'}`;
          indicator.innerHTML = disponibile ? '&#10003;' : '&#10007;'; // Checkmark o X
          btn.appendChild(indicator);
          
          profilesList.append(btn);
        });
        
        renderNotesDashboard();
      }

      // MODIFICATO: Render bacheca note
      function renderNotesDashboard() {
        notesDashboard.innerHTML = '';
        
        let hasNotes = false;
        
        // Controlliamo le note di tutti i cavalli
        for (const horseName of cavalli) {
          const horseNotes = cavalliNotes[horseName] || [];
          
          // Verifichiamo se questo cavallo ha note
          if (horseNotes.length > 0) {
            hasNotes = true;
            
            // Aggiungiamo ciascuna nota separatamente
            horseNotes.forEach(note => {
              // Verifichiamo se questa nota √® marcata come "da gestire"
              const noteId = note.id || Date.now().toString();
              const needsManagement = noteDaGestire[noteId] === true;
              
              const noteCard = document.createElement('div');
              noteCard.className = 'note-card' + (needsManagement ? ' border-danger' : '');
              
              const horseNameEl = document.createElement('div');
              horseNameEl.className = 'horse-name';
              horseNameEl.textContent = horseName;
              
              // Aggiungi indicatore di disponibilit√†
              if (!cavalliDisponibilita[horseName]) {
                const availabilitySpan = document.createElement('span');
                availabilitySpan.className = 'badge bg-danger ms-2';
                availabilitySpan.textContent = 'Non disponibile';
                horseNameEl.appendChild(availabilitySpan);
              }
              
              // Aggiungi data della nota
              const dateEl = document.createElement('small');
              dateEl.className = 'text-muted ms-2';
              if (note.date) {
                const noteDate = new Date(note.date);
                dateEl.textContent = noteDate.toLocaleDateString('it') + ' ' + 
                                    noteDate.toLocaleTimeString('it', {hour: '2-digit', minute: '2-digit'});
              } else {
                dateEl.textContent = 'Data non disponibile';
              }
              horseNameEl.appendChild(dateEl);
              
              const noteContent = document.createElement('div');
              noteContent.className = 'note-content';
              noteContent.textContent = note.text;
              
              const actions = document.createElement('div');
              actions.className = 'note-actions';
              
              const viewBtn = document.createElement('button');
              viewBtn.className = 'btn btn-sm btn-outline-primary';
              viewBtn.textContent = 'Visualizza profilo';
              viewBtn.onclick = () => openProfile(horseName);
              
              const manageBtn = document.createElement('button');
              manageBtn.className = 'btn btn-sm ' + (needsManagement ? 'btn-success' : 'btn-outline-warning');
              manageBtn.textContent = needsManagement ? 'Completata' : 'Segna come da gestire';
              manageBtn.onclick = () => {
                // Toggle lo stato "da gestire"
                if (needsManagement) {
                  delete noteDaGestire[noteId];
                } else {
                  noteDaGestire[noteId] = true;
                }
                saveNotesToManage();
                renderNotesDashboard();
              };
              
              const removeBtn = document.createElement('button');
              removeBtn.className = 'btn btn-sm btn-outline-danger';
              removeBtn.textContent = 'Rimuovi nota';
              removeBtn.onclick = () => {
                // Rimuove la nota
                cavalliNotes[horseName] = cavalliNotes[horseName].filter(n => n.id !== noteId);
                
                // Se la nota era marcata come "da gestire", rimuovi anche quella
                if (noteDaGestire[noteId]) {
                  delete noteDaGestire[noteId];
                  saveNotesToManage();
                }
                
                saveHorseNotes();
                renderNotesDashboard();
              };
              
              actions.append(viewBtn, manageBtn, removeBtn);
              noteCard.append(horseNameEl, noteContent, actions);
              notesDashboard.append(noteCard);
            });
          }
        }
        
        if (!hasNotes) {
          const emptyMessage = document.createElement('div');
          emptyMessage.className = 'alert alert-light';
          emptyMessage.textContent = 'Non ci sono note da visualizzare.';
          notesDashboard.append(emptyMessage);
        }
      }

      // Aggiungi cavallo
      addHorseBtn.onclick = ()=>{
        const name = newHorseInput.value.trim();
        if(!name) return alert('Inserisci nome valido!');
        if(cavalli.includes(name)) return alert('Cavallo gi√† esistente!');
        cavalli.push(name); 
        cavalli.sort(); 
        
        // Imposta disponibilit√† predefinita per nuovo cavallo
        cavalliDisponibilita[name] = true;
        saveHorseAvailability();
        
        // Inizializza array note vuoto per il nuovo cavallo
        cavalliNotes[name] = [];
        saveHorseNotes();
        
        saveHorses(); 
        newHorseInput.value='';
      };

      // Gestione eliminazione cavallo dal profilo
      deleteHorseBtn.onclick = ()=>{
        confirmDeleteHorse(currentHorse);
      };

      // Gestione disponibilit√† cavallo
      toggleAvailabilityBtn.onclick = () => {
        // Toggle disponibilit√†
        cavalliDisponibilita[currentHorse] = !cavalliDisponibilita[currentHorse];
        
        // Aggiorna UI
        updateAvailabilityButton();
        
        // Salva
        saveHorseAvailability();
        
        // Aggiorna interfaccia utente
        renderHorsesUI();
      };
      
      // Aggiornamento pulsante disponibilit√†
      function updateAvailabilityButton() {
        const disponibile = cavalliDisponibilita[currentHorse];
        
        if (disponibile) {
          toggleAvailabilityBtn.textContent = 'Rendi indisponibile';
          toggleAvailabilityBtn.className = 'btn btn-danger';
        } else {
          toggleAvailabilityBtn.textContent = 'Rendi disponibile';
          toggleAvailabilityBtn.className = 'btn btn-success';
        }
      }

      // Conferma/elimina cavallo
      function confirmDeleteHorse(h){
        document.getElementById('delete-horse-name').textContent = h;
        confirmDeleteHorseBtn.dataset.horse = h;
        deleteHorseModal.show();
      }
      confirmDeleteHorseBtn.onclick = ()=>{
        const h = confirmDeleteHorseBtn.dataset.horse;
        cavalli = cavalli.filter(x=>x!==h);
        calendar.getEvents().forEach(ev=>{
          if(ev.extendedProps.horses?.includes(h)){
            const arr = ev.extendedProps.horses.filter(x=>x!==h);
            ev.setExtendedProp('horses',arr);
            const t = ev.extendedProps.type;
            ev.setProp('title', t + (arr.length?` (${arr.join(',')})`:``));
          }
        });
        
        delete cavalliNotes[h]; 
        delete cavalliFerratura[h]; // NUOVO: Rimuovi anche data ferratura
        
        // Rimuovi tutte le note da gestire di questo cavallo
        for (const noteId in noteDaGestire) {
          delete noteDaGestire[noteId];
        }
        
        delete cavalliDisponibilita[h]; // Rimuovi anche disponibilit√†
        saveHorseNotes();
        saveNotesToManage();
        saveHorseAvailability();
        saveHorseFerratura(); // NUOVO: Salva anche date ferratura
        saveHorses(); saveEvents(); updateAll();
        deleteHorseModal.hide();
        profileModal.hide(); // Chiude anche il modale del profilo
      };

      // Gestione ora di inizio e fine
      function updateEndTimeBasedOnStart() {
        const startTime = new Date(startEl.value);
        // Calcoliamo la fine esattamente un'ora dopo
        const endTime = new Date(startTime.getTime() + 3600000);
        // Impostiamo il valore dell'input di fine usando il formato corretto
        endEl.value = formatDateTimeLocal(endTime);
      }

      // Formatta data per datetime-local input
      function formatDateTimeLocal(date) {
        // Considera il fuso orario locale
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        
        return `${year}-${month}-${day}T${hours}:${minutes}`;
      }
      
      // Apri form evento
      function openForm(ev, start, end){
        editingEvent = ev;
        modalTitle.textContent = ev ? 'Modifica Attivit√†' : 'Nuova Attivit√†';
        renderHorsesUI();
        
        // Reset della selezione dei cavalli
        Array.from(selectEl.options).forEach(opt => {
          opt.selected = false;
        });
        
        typeEl.value = ev?.extendedProps.type || '';
        
        // Se √® un nuovo evento, impostiamo l'ora di inizio e fine di default
        if (!ev) {
          // Usiamo il formato corretto per evitare problemi di fuso orario
          startEl.value = formatDateTimeLocal(start);
          endEl.value = formatDateTimeLocal(end);
          // Reset note per nuovo evento
          notesEl.value = '';
        } else {
          // Se √® un evento esistente, manteniamo gli orari originali
          startEl.value = formatDateTimeLocal(ev.start);
          endEl.value = formatDateTimeLocal(ev.end);
          notesEl.value = ev?.extendedProps.notes || '';
          
          // Seleziona i cavalli dell'evento esistente
          ev.extendedProps.horses.forEach(h => {
            const o = selectEl.querySelector(`option[value="${h}"]`);
            if(o) o.selected = true;
          });
        }
        
        // Quando l'orario di inizio cambia, aggiorniamo automaticamente l'orario di fine
        startEl.onchange = () => {
          // Solo per nuovi eventi impostiamo automaticamente l'orario di fine
          if (!ev) {
            updateEndTimeBasedOnStart();
          } else {
            // Per eventi esistenti controlliamo solo che l'orario di fine non sia precedente all'inizio
            const s = new Date(startEl.value),
                  e = new Date(endEl.value);
            if (e <= s) {
              endEl.value = formatDateTimeLocal(new Date(s.getTime() + 3600000));
            }
          }
        };
        
        // Verifica cavalli indisponibili quando si apre il form
        checkSelectedUnavailableHorses();
        
        deleteBtn.style.display = ev ? 'inline-block' : 'none';
        eventModal.show();
      }

      // Salva evento
      saveBtn.onclick = ()=>{
        const hs = Array.from(selectEl.selectedOptions).map(o=>o.value);
        const tp = typeEl.value, nt = notesEl.value.trim();
        
        // Otteniamo le date di inizio e fine esatte
        const s = new Date(startEl.value);
        const ed = new Date(endEl.value);
        
        if(!activities.includes(tp) || ed <= s) return alert('Tipo o orari errati');
        
        // Verifica disponibilit√† cavalli per lezioni e passeggiate
        if ((tp === 'passeggiata' || tp === 'lezione') && hs.some(h => !cavalliDisponibilita[h])) {
          return alert('Non puoi programmare lezioni o passeggiate con cavalli non disponibili!');
        }
        
        // Verifica conflitti solo con altri eventi (non con l'evento corrente)
        // e solo se ci sono cavalli selezionati e solo per eventi che coinvolgono gli stessi cavalli
        const conflict = hs.length > 0 && calendar.getEvents().some(ev => {
          // Ignora se √® lo stesso evento
          if (editingEvent && ev.id === editingEvent.id) return false;
          
          // Verifica sovrapposizione temporale
          const evStart = ev.start, evEnd = ev.end;
          const isOverlapping = (s < evEnd && ed > evStart);
          
          // Verifica se ci sono cavalli in comune
          const hasCommonHorses = ev.extendedProps.horses.some(h => hs.includes(h));
          
          return isOverlapping && hasCommonHorses;
        });

        if (conflict) {
          return alert('Conflitto: cavallo gi√† impegnato in questo orario!');
        }

        // Prepara titolo con tipo e cavalli se presenti
        const title = tp + (hs.length ? ` (${hs.join(',')})` : '');

        // Modifica evento esistente o crea nuovo
        if (editingEvent) {
          editingEvent.setProp('title', title);
          editingEvent.setProp('backgroundColor', activityColors[tp]);
          editingEvent.setStart(s);
          editingEvent.setEnd(ed);
          editingEvent.setExtendedProp('type', tp);
          editingEvent.setExtendedProp('horses', hs);
          editingEvent.setExtendedProp('notes', nt);
        } else {
          // Crea nuovo evento con ID univoco
          calendar.addEvent({
            id: Date.now().toString(),
            title: title,
            start: s,
            end: ed,
            backgroundColor: activityColors[tp],
            extendedProps: {
              type: tp,
              horses: hs,
              notes: nt
            }
          });
        }

        saveEvents();
        updateAll();
        eventModal.hide();
      };

      // Elimina evento
      deleteBtn.onclick = () => {
        if (confirm('Sei sicuro di voler eliminare questo evento?')) {
          editingEvent.remove();
          saveEvents();
          updateAll();
          eventModal.hide();
        }
      };

      // MODIFICATO: Apri profilo cavallo
      function openProfile(h) {
        currentHorse = h;
        profileTitle.textContent = `Profilo di ${h}`;
        
        // Reset e pulizia campo note
        horseNotesEl.value = '';
        
        // Renderizza lista note del cavallo
        renderHorseNotesList(h);
        
        // Imposta data ferratura (se esistente)
        shoeingDateEl.value = cavalliFerratura[h] || '';
        
        // Aggiorna pulsante disponibilit√†
        updateAvailabilityButton();
        
        // Mostra eventi del cavallo
        const events = calendar.getEvents()
          .filter(ev => ev.extendedProps.horses?.includes(h))
          .sort((a, b) => a.start - b.start);
        
        profileEvents.innerHTML = '';
        
        if (events.length === 0) {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = 'Nessun evento programmato';
          profileEvents.append(li);
        } else {
          events.forEach(ev => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-start';
            
            const dateStr = new Date(ev.start).toLocaleDateString('it');
            const timeStr = `${new Date(ev.start).toLocaleTimeString('it', {hour: '2-digit', minute: '2-digit'})} - ${new Date(ev.end).toLocaleTimeString('it', {hour: '2-digit', minute: '2-digit'})}`;
            
            const main = document.createElement('div');
            main.className = 'ms-2 me-auto';
            
            const titleEl = document.createElement('div');
            titleEl.className = 'fw-bold';
            titleEl.textContent = ev.extendedProps.type;
            
            const detail = document.createElement('div');
            detail.textContent = `${dateStr}, ${timeStr}`;
            
            if (ev.extendedProps.notes) {
              const notes = document.createElement('div');
              notes.className = 'note-text mt-1';
              notes.textContent = ev.extendedProps.notes;
              main.append(titleEl, detail, notes);
            } else {
              main.append(titleEl, detail);
            }
            
            const badge = document.createElement('span');
            badge.className = 'badge rounded-pill';
            badge.style.backgroundColor = activityColors[ev.extendedProps.type];
            
            // Calcola durata evento in ore
            const hours = (ev.end - ev.start) / (1000 * 60 * 60);
            badge.textContent = `${hours.toFixed(1)}h`;
            
            const viewBtn = document.createElement('button');
            viewBtn.className = 'btn btn-sm btn-outline-primary mt-2';
            viewBtn.textContent = 'Visualizza';
            viewBtn.onclick = () => {
              profileModal.hide();
              openForm(ev, ev.start, ev.end);
            };
            
            li.append(main, badge);
            main.append(viewBtn);
            profileEvents.append(li);
          });
        }
        
        profileModal.show();
      }

      // NUOVO: Renderizza lista note del cavallo
      function renderHorseNotesList(horseName) {
        horseNotesListEl.innerHTML = '';
        
        const notes = cavalliNotes[horseName] || [];
        
        if (notes.length === 0) {
          const emptyMessage = document.createElement('div');
          emptyMessage.className = 'text-muted text-center py-2';
          emptyMessage.textContent = 'Nessuna nota disponibile';
          horseNotesListEl.append(emptyMessage);
          return;
        }
        
        // Ordina note per data (pi√π recenti prima)
        const sortedNotes = [...notes].sort((a, b) => {
          return new Date(b.date) - new Date(a.date);
        });
        
        // Aggiungi ciascuna nota
        sortedNotes.forEach(note => {
          const noteItem = document.createElement('div');
          noteItem.className = 'note-item';
          
          // Aggiungi data della nota
          const dateEl = document.createElement('div');
          dateEl.className = 'note-date';
          if (note.date) {
            const noteDate = new Date(note.date);
            dateEl.textContent = noteDate.toLocaleDateString('it') + ' ' + 
                                noteDate.toLocaleTimeString('it', {hour: '2-digit', minute: '2-digit'});
          } else {
            dateEl.textContent = 'Data non disponibile';
          }
          
          // Pulsante elimina nota
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'btn btn-sm btn-outline-danger delete-note-btn';
          deleteBtn.innerHTML = '&times;';
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            // Rimuovi nota
            cavalliNotes[horseName] = cavalliNotes[horseName].filter(n => n.id !== note.id);
            
            // Se la nota era marcata come "da gestire", rimuovi anche quella
            if (noteDaGestire[note.id]) {
              delete noteDaGestire[note.id];
              saveNotesToManage();
            }
            
            saveHorseNotes();
            renderHorseNotesList(horseName);
            renderNotesDashboard();
          };
          
          // Contenuto della nota
          const contentEl = document.createElement('div');
          contentEl.className = 'note-content';
          contentEl.textContent = note.text;
          
          // Aggiungi indicatore "da gestire" se necessario
          if (noteDaGestire[note.id]) {
            const badgeEl = document.createElement('span');
            badgeEl.className = 'badge bg-danger ms-2';
            badgeEl.textContent = 'Da gestire';
            dateEl.appendChild(badgeEl);
          }
          
          noteItem.append(dateEl, deleteBtn, contentEl);
          horseNotesListEl.append(noteItem);
        });
      }

      // MODIFICATO: Salva nota cavallo (ora aggiunge una nuova nota)
      saveHorseNotesBtn.onclick = () => {
        const noteText = horseNotesEl.value.trim();
        if (!noteText) return;
        
        if (!currentHorse) return;
        
        // Crea nuova nota
        const newNote = {
          id: Date.now().toString(),
          text: noteText,
          date: new Date().toISOString()
        };
        
        // Verifica se l'array esiste gi√†
        if (!cavalliNotes[currentHorse]) {
          cavalliNotes[currentHorse] = [];
        }
        
        // Aggiungi nuova nota
        cavalliNotes[currentHorse].push(newNote);
        
        // Aggiungi per default come nota da gestire
        noteDaGestire[newNote.id] = true;
        
        // Salva
        saveHorseNotes();
        saveNotesToManage();
        
        // Pulisci campo input e aggiorna UI
        horseNotesEl.value = '';
        renderHorseNotesList(currentHorse);
        renderNotesDashboard();
        
        alert('Nota aggiunta!');
      };

      // Imposta data per oggi di default
      dateInput.value = todayFormatted;
      dateInput.oninput = updateAll;

      // Utility per calcolare ore di cavallo
      function getHoursWorked(h, start, end, dailyOnly = false) {
        let total = 0;
        
        calendar.getEvents().forEach(ev => {
          // Controlla se il cavallo √® presente
          if (!ev.extendedProps.horses?.includes(h)) return;
          
          // Controlla se l'attivit√† √® di lavoro
          if (!workActivities.includes(ev.extendedProps.type)) return;
          
          // Controlla periodo (giorno o settimana)
          const evStart = new Date(ev.start);
          const evDate = evStart.toISOString().slice(0, 10);
          
          if (dailyOnly) {
            // Solo eventi del giorno selezionato
            if (evDate !== start) return;
          } else {
            // Solo eventi nella settimana selezionata
            if (evStart < start || evStart > end) return;
          }
          
          // Calcola ore
          const hours = (ev.end - ev.start) / (1000 * 60 * 60);
          total += hours;
        });
        
        return total;
      }

      // Aggiorna tutti i riepiloghi
      function updateAll() {
        const date = dateInput.value;
        
        // Calcola inizio e fine settimana
        const d = new Date(date);
        const day = d.getDay() || 7; // 0 = domenica, quindi diventa 7
        
        // Trova luned√¨ della settimana corrente
        const monday = new Date(d);
        monday.setDate(d.getDate() - day + 1);
        
        // Trova domenica della settimana corrente
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        
        // Formatta per visualizzazione
        const mondayStr = monday.toLocaleDateString('it');
        const sundayStr = sunday.toLocaleDateString('it');
        weekRangeEl.textContent = `(${mondayStr} - ${sundayStr})`;
        
        // Aggiorna ore di lavoro giornaliere
        hoursEl.innerHTML = '';
        let dailyTotalHours = 0;
        
        cavalli.forEach(h => {
          const hours = getHoursWorked(h, date, null, true);
          if (hours > 0) {
            dailyTotalHours += hours;
            const li = document.createElement('div');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.textContent = h;
            
            // Aggiungi indicatore di disponibilit√†
            if (!cavalliDisponibilita[h]) {
              const badge = document.createElement('span');
              badge.className = 'badge bg-danger me-2';
              badge.textContent = 'Non disponibile';
              li.appendChild(badge);
            }
            
            const badge = document.createElement('span');
            badge.className = `badge bg-primary rounded-pill ${getHoursColorClass(hours)}`;
            badge.textContent = `${hours.toFixed(1)}h`;
            
            li.appendChild(badge);
            hoursEl.append(li);
          }
        });
        
        // Totale ore giornaliere - SEMPRE BLU
        if (dailyTotalHours > 0) {
          const li = document.createElement('div');
          li.className = 'list-group-item d-flex justify-content-between align-items-center fw-bold';
          li.textContent = 'Totale';
          
          const badge = document.createElement('span');
          badge.className = `badge bg-primary rounded-pill ${getHoursColorClass(dailyTotalHours, true, true)}`; // Il terzo parametro indica che √® un totale
          badge.textContent = `${dailyTotalHours.toFixed(1)}h`;
          
          li.appendChild(badge);
          hoursEl.append(li);
        } else if (hoursEl.innerHTML === '') {
          hoursEl.innerHTML = '<div class="list-group-item">Nessuna attivit√† di lavoro</div>';
        }
        
        // Aggiorna ore settimanali
        weeklyHoursEl.innerHTML = '';
        let weeklyTotalHours = 0;
        
        cavalli.forEach(h => {
          const hours = getHoursWorked(h, monday, sunday);
          if (hours > 0) {
            weeklyTotalHours += hours;
            const li = document.createElement('div');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.textContent = h;
            
            // Aggiungi indicatore di disponibilit√†
            if (!cavalliDisponibilita[h]) {
              const badge = document.createElement('span');
              badge.className = 'badge bg-danger me-2';
              badge.textContent = 'Non disponibile';
              li.appendChild(badge);
            }
            
            const badge = document.createElement('span');
            badge.className = `badge bg-primary rounded-pill ${getHoursColorClass(hours, false)}`;
            badge.textContent = `${hours.toFixed(1)}h`;
            
            li.appendChild(badge);
            weeklyHoursEl.append(li);
          }
        });
        
        // Totale ore settimanali - SEMPRE BLU
        if (weeklyTotalHours > 0) {
          const li = document.createElement('div');
          li.className = 'list-group-item d-flex justify-content-between align-items-center fw-bold';
          li.textContent = 'Totale';
          
          const badge = document.createElement('span');
          badge.className = `badge bg-primary rounded-pill ${getHoursColorClass(weeklyTotalHours, false, true)}`; // Il terzo parametro indica che √® un totale
          badge.textContent = `${weeklyTotalHours.toFixed(1)}h`;
          
          li.appendChild(badge);
          weeklyHoursEl.append(li);
        } else if (weeklyHoursEl.innerHTML === '') {
          weeklyHoursEl.innerHTML = '<div class="list-group-item">Nessuna attivit√† di lavoro</div>';
        }
        
        // Aggiorna eventi giornalieri
        updateEventsList(date, null, true, dailyListEl);
        
        // Aggiorna eventi settimanali
        updateEventsList(monday, sunday, false, weeklyListEl);
      }

      // MODIFICATO: Aggiorna lista eventi con divisori per giorni negli eventi settimanali
      function updateEventsList(start, end, isDaily, container) {
        container.innerHTML = '';
        
        // Filtra eventi
        let events = calendar.getEvents().filter(ev => {
          const evStart = new Date(ev.start);
          const evDate = evStart.toISOString().slice(0, 10);
          
          if (isDaily) {
            // Solo eventi del giorno selezionato
            return evDate === start;
          } else {
            // Solo eventi nella settimana selezionata
            return evStart >= start && evStart <= end;
          }
        }).sort((a, b) => a.start - b.start);
        
        if (events.length === 0) {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = 'Nessun evento programmato';
          container.append(li);
          return;
        }
        
        // Per gli eventi settimanali, organizza per giorno
        if (!isDaily) {
          // Raggruppa eventi per giorno
          const eventsByDay = {};
          
          events.forEach(ev => {
            const evDate = new Date(ev.start).toISOString().slice(0, 10);
            if (!eventsByDay[evDate]) {
              eventsByDay[evDate] = [];
            }
            eventsByDay[evDate].push(ev);
          });
          
          // Crea divisori per ogni giorno
          const sortedDates = Object.keys(eventsByDay).sort();
          
          sortedDates.forEach(date => {
            // Aggiungi divisore per il giorno
            const dateObj = new Date(date);
            const dayName = dateObj.toLocaleDateString('it', {weekday: 'long'});
            const dayNumber = dateObj.getDate();
            const monthName = dateObj.toLocaleDateString('it', {month: 'long'});
            
            const divider = document.createElement('div');
            divider.className = 'day-divider';
            divider.textContent = `${dayName} ${dayNumber} ${monthName}`;
            container.append(divider);
            
            // Aggiungi eventi del giorno
            eventsByDay[date].forEach(ev => {
              addEventToList(ev, container, false);
            });
          });
        } else {
          // Per eventi giornalieri, semplicemente lista tutti gli eventi
          events.forEach(ev => {
            addEventToList(ev, container, true);
          });
        }
      }
      
      // Helper per aggiungere un evento alla lista
      function addEventToList(ev, container, isDaily) {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        
        const timeStr = `${new Date(ev.start).toLocaleTimeString('it', {hour: '2-digit', minute: '2-digit'})} - ${new Date(ev.end).toLocaleTimeString('it', {hour: '2-digit', minute: '2-digit'})}`;
        
        const dateSpan = document.createElement('span');
        dateSpan.className = 'badge text-bg-secondary me-2';
        
        // Mostra data solo negli eventi settimanali
        if (!isDaily) {
          dateSpan.textContent = new Date(ev.start).toLocaleDateString('it', {weekday: 'short', day: 'numeric'});
          li.append(dateSpan);
        }
        
        const typeSpan = document.createElement('span');
        typeSpan.className = 'badge me-2';
        typeSpan.style.backgroundColor = activityColors[ev.extendedProps.type];
        typeSpan.textContent = ev.extendedProps.type;
        
        const timeSpan = document.createElement('span');
        timeSpan.className = 'me-2';
        timeSpan.textContent = timeStr;
        
        const horsesSpan = document.createElement('span');
        horsesSpan.className = 'fw-bold';
        
        // Aggiungi indicatori di disponibilit√† per i cavalli
        const horses = ev.extendedProps.horses;
        if (horses.length) {
          horses.forEach((h, idx) => {
            const horseSpan = document.createElement('span');
            horseSpan.textContent = h;
            
            // Aggiungi classe in base alla disponibilit√†
            if (!cavalliDisponibilita[h]) {
              horseSpan.className = 'text-danger';
            }
            
            // Aggiungi virgola se non √® l'ultimo cavallo
            if (idx < horses.length - 1) {
              horseSpan.textContent += ', ';
            }
            
            horsesSpan.appendChild(horseSpan);
          });
        } else {
          horsesSpan.textContent = 'Nessun cavallo';
        }
        
        li.append(typeSpan, timeSpan, horsesSpan);
        
        if (ev.extendedProps.notes) {
          const notesEl = document.createElement('div');
          notesEl.className = 'note-text mt-1';
          notesEl.textContent = ev.extendedProps.notes;
          li.append(notesEl);
        }
        
        const btnShowEvent = document.createElement('button');
        btnShowEvent.className = 'btn btn-sm btn-outline-primary mt-2';
        btnShowEvent.textContent = 'Visualizza';
        btnShowEvent.onclick = () => openForm(ev, ev.start, ev.end);
        li.append(btnShowEvent);
        
        container.append(li);
      }

      // Gestione colori basati sul numero di ore
      function getHoursColorClass(hours, isDaily = true, isTotal = false) {
        // Se √® un totale, ritorna sempre classe per totale (blu)
        if (isTotal) {
          return 'total-hours';
        }
        
        if (isDaily) {
          // Logica per le ore giornaliere
          if (hours <= 3) return 'hours-low';
          if (hours <= 5) return 'hours-medium';
          return 'hours-high';
        } else {
          // Logica per le ore settimanali
          if (hours <= 18) return 'hours-low';
          if (hours <= 30) return 'hours-medium';
          return 'hours-high';
        }
      }

      // Carica i dati iniziali e configura gli aggiornamenti in tempo reale
      loadData();
    }
  });
  </script>
</body>
</html>
